#!/bin/bash

# ==========================================
# 代理快捷指令一键安装脚本
# 使用方法:
#   交互式: bash <(curl -sL URL)
#   静默式: bash <(curl -sL URL) 10.10.1.3 6152
# ==========================================

GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo -e "${GREEN}=== 代理快捷指令配置工具 (setproxy) ===${NC}"

# 1. 自动检测 Shell 配置文件
if [[ "$SHELL" == *"zsh"* ]]; then
    CONFIG_FILE="$HOME/.zshrc"
elif [[ -f "$HOME/.bashrc" ]]; then
    CONFIG_FILE="$HOME/.bashrc"
else
    CONFIG_FILE="$HOME/.profile"
fi

echo -e "目标配置文件: ${YELLOW}$CONFIG_FILE${NC}"

# 2. 获取 IP 和 端口
# 逻辑：如果脚本后面带了参数 ($1, $2)，就直接用；否则询问用户
PROXY_IP=$1
PROXY_PORT=$2

if [[ -z "$PROXY_IP" ]]; then
    # 关键修改： < /dev/tty 确保在 curl | bash 模式下也能读取键盘
    echo ""
    read -p "请输入代理服务器 IP (默认 127.0.0.1): " input_ip < /dev/tty
    PROXY_IP=${input_ip:-127.0.0.1}
fi

if [[ -z "$PROXY_PORT" ]]; then
    read -p "请输入代理端口 (默认 7890): " input_port < /dev/tty
    PROXY_PORT=${input_port:-7890}
fi

echo -e "即将设置代理: ${GREEN}${PROXY_IP}:${PROXY_PORT}${NC}"

# 3. 备份与清理旧配置
cp "$CONFIG_FILE" "${CONFIG_FILE}.bak"

START_MARKER="# ================= Proxy Settings (Auto-Generated) ================="
END_MARKER="# ================================================================="

# 如果存在旧配置，先删除
if grep -qF "$START_MARKER" "$CONFIG_FILE"; then
    # 适配 Linux/MacOS 的 sed 差异
    if [[ "$OSTYPE" == "darwin"* ]]; then
        sed -i '' "/$START_MARKER/,/$END_MARKER/d" "$CONFIG_FILE"
    else
        sed -i "/$START_MARKER/,/$END_MARKER/d" "$CONFIG_FILE"
    fi
    echo "清理旧配置完成。"
fi

# 4. 写入新配置
cat >> "$CONFIG_FILE" <<EOF

$START_MARKER
# 代理地址变量
PROXY_HOST="$PROXY_IP"
PROXY_PORT="$PROXY_PORT"

# 开启代理
alias setproxy="export http_proxy=http://\$PROXY_HOST:\$PROXY_PORT && \\
                export https_proxy=http://\$PROXY_HOST:\$PROXY_PORT && \\
                export ftp_proxy=http://\$PROXY_HOST:\$PROXY_PORT && \\
                export all_proxy=http://\$PROXY_HOST:\$PROXY_PORT && \\
                echo -e '\033[32m[Proxy ON] 已开启代理 -> \$PROXY_HOST:\$PROXY_PORT\033[0m'"

# 关闭代理
alias unsetproxy="unset http_proxy https_proxy ftp_proxy all_proxy && \\
                  echo -e '\033[31m[Proxy OFF] 代理已关闭，恢复直连\033[0m'"

# 查看当前 IP
alias myip="curl -s --connect-timeout 5 ipinfo.io/ip"
$END_MARKER
EOF

echo -e "${GREEN}配置写入成功！${NC}"

# 5. 提示生效 (因为子进程无法修改父进程环境，必须提示用户手动 source)
echo ""
echo -e "${YELLOW}!!! 安装完成，请执行以下命令立即生效 !!!${NC}"
echo -e "${GREEN}source $CONFIG_FILE${NC}"
echo ""
echo "使用说明:"
echo "  setproxy   - 开启代理"
echo "  unsetproxy - 关闭代理"
echo "  myip       - 查看当前 IP"
