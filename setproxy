#!/bin/bash

# =================================================================
# 代理快捷指令一键管理脚本 (安装/卸载)
#
# 使用方法:
#   1. 交互式安装:  bash <(curl -sL URL)
#   2. 静默安装:    bash <(curl -sL URL) 10.10.1.3 6152
#   3. 一键卸载:    bash <(curl -sL URL) uninstall
# =================================================================

GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m'

# 定义配置块的开始和结束标记 (必须唯一，用于精准定位和删除)
START_MARKER="# ================= Proxy Settings (Auto-Generated) ================="
END_MARKER="# ================================================================="

# 1. 自动检测 Shell 配置文件
if [[ "$SHELL" == *"zsh"* ]]; then
    CONFIG_FILE="$HOME/.zshrc"
elif [[ -f "$HOME/.bashrc" ]]; then
    CONFIG_FILE="$HOME/.bashrc"
else
    CONFIG_FILE="$HOME/.profile"
fi

# ================= 卸载逻辑 =================
if [[ "$1" == "uninstall" ]]; then
    echo -e "${YELLOW}正在检测配置文件: $CONFIG_FILE ...${NC}"
    
    if grep -qF "$START_MARKER" "$CONFIG_FILE"; then
        # 备份文件
        cp "$CONFIG_FILE" "${CONFIG_FILE}.bak_uninstall"
        echo -e "已备份原配置至: ${CONFIG_FILE}.bak_uninstall"
        
        # 执行删除
        if [[ "$OSTYPE" == "darwin"* ]]; then
            sed -i '' "/$START_MARKER/,/$END_MARKER/d" "$CONFIG_FILE"
        else
            sed -i "/$START_MARKER/,/$END_MARKER/d" "$CONFIG_FILE"
        fi
        
        echo -e "${GREEN}卸载成功！代理配置已从 $CONFIG_FILE 中移除。${NC}"
        echo -e "${YELLOW}请执行 [ source $CONFIG_FILE ] 或重启终端以彻底清除残留别名。${NC}"
    else
        echo -e "${RED}未在 $CONFIG_FILE 中发现代理配置，无需卸载。${NC}"
    fi
    exit 0
fi
# ===========================================

echo -e "${GREEN}=== 代理快捷指令配置工具 (setproxy) ===${NC}"
echo -e "目标配置文件: ${YELLOW}$CONFIG_FILE${NC}"

# 2. 获取 IP 和 端口
PROXY_IP=$1
PROXY_PORT=$2

if [[ -z "$PROXY_IP" ]]; then
    # < /dev/tty 确保在 curl | bash 模式下也能读取键盘
    echo ""
    read -p "请输入代理服务器 IP (默认 127.0.0.1): " input_ip < /dev/tty
    PROXY_IP=${input_ip:-127.0.0.1}
fi

if [[ -z "$PROXY_PORT" ]]; then
    read -p "请输入代理端口 (默认 7890): " input_port < /dev/tty
    PROXY_PORT=${input_port:-7890}
fi

echo -e "即将设置代理: ${GREEN}${PROXY_IP}:${PROXY_PORT}${NC}"

# 3. 清理旧配置 (如果存在，先删后加，防止重复)
if grep -qF "$START_MARKER" "$CONFIG_FILE"; then
    if [[ "$OSTYPE" == "darwin"* ]]; then
        sed -i '' "/$START_MARKER/,/$END_MARKER/d" "$CONFIG_FILE"
    else
        sed -i "/$START_MARKER/,/$END_MARKER/d" "$CONFIG_FILE"
    fi
fi

# 4. 写入新配置
cat >> "$CONFIG_FILE" <<EOF

$START_MARKER
# 代理地址变量
PROXY_HOST="$PROXY_IP"
PROXY_PORT="$PROXY_PORT"

# 开启代理
alias setproxy="export http_proxy=http://\$PROXY_HOST:\$PROXY_PORT && \\
                export https_proxy=http://\$PROXY_HOST:\$PROXY_PORT && \\
                export ftp_proxy=http://\$PROXY_HOST:\$PROXY_PORT && \\
                export all_proxy=http://\$PROXY_HOST:\$PROXY_PORT && \\
                echo -e '\033[32m[Proxy ON] 已开启代理 -> \$PROXY_HOST:\$PROXY_PORT\033[0m'"

# 关闭代理
alias unsetproxy="unset http_proxy https_proxy ftp_proxy all_proxy && \\
                  echo -e '\033[31m[Proxy OFF] 代理已关闭，恢复直连\033[0m'"

# 查看当前 IP
alias myip="curl -s --connect-timeout 5 ipinfo.io/ip"
$END_MARKER
EOF

echo -e "${GREEN}配置写入成功！${NC}"
echo ""
echo -e "${YELLOW}!!! 安装完成，请执行以下命令立即生效 !!!${NC}"
echo -e "${GREEN}source $CONFIG_FILE${NC}"
